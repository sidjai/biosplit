---
title: "Auto Report"
author: "Siddarta Jairam"
date: '`r strftime(Sys.time(),"%A, %B %d, %Y")`'
geometry: margin=1in
output: 
  word_document:
    reference_docx: rmdTemp.docx
params:
  runs: c("runFDHighLatThres", "runMultYearDv020")
  years: c(2013, 2011)
  dirSim: "C:/Users/Siddarta.Jairam/Documents/Hysplit Out Moth table"
  trapDump: "C:/Users/Siddarta.Jairam/Documents/Documentation/PestWatchDump.xlsx"
  scrubbedHap: "C:/Users/Siddarta.Jairam/Documents/Documentation/hapDat%d.csv"
  niceGrid: "None"
---

```{r setup, include=FALSE}
library(knitr)
library(jpeg)
library(biosplit)
knitr::opts_chunk$set(echo=FALSE, comment='>', dpi=600)
realWd <- system.file(package = "biosplit", "docs")
figList <- list()
source(paste(realWd,"rmdUtils.R",sep='/'))

```

This report will compare these runs:

```{r context}
if(is.character(niceGrid)){
	stop(paste("Supply a raster with the final projection in 'niceGrid'"))
}
	
#runs <- c('runDataRedo','runHelloWorld','runInterYear','runFLwinter')
#years <- c('2011','2012','2013','2014')
goldLoc <- "C:/Program Files/Golden Software/Surfer 12"
runScripter <- makeRunFun(goldLoc, "BAS")
# params <- list()
#params$runs <- c('runInterYear','runAbsFlightLimit','runNightDurDel','runFlightAndNight')
# params$runs <- c("runBaseFullNight", "runBFNTOcueTemp", "runBFNTOcuePrec")
# params$runs <- c("runBaseNightandFlight", "runFDHighLatThres","runFNHighLatThres")
# params$years <- c("2013", "2013", "2013")
rwyear <- paste(params$years, params$runs, sep='/')
# params$dirSim <- "C:/Users/Siddarta.Jairam/Documents/Hysplit Out Moth table"
fullDir <- paste(params$dirSim, rwyear,sep='/')
numRuns <- length(rwyear)
compareRuns <- 1:numRuns
cat(paste(rwyear,colllapse='|'))
```

The conditions that the run was done in are as follows:

```{r conditions}
condFiles <- vapply(fullDir,function(x){
	readLines(paste(x,'Conditions.txt',sep='/'))
	},rep('one',5))
cat(condFiles[3:4,2])
```

The differences between the different runs are as follows:

```{r}
bioDiff <- findDiff(condFiles[3,], cleanLabel(rwyear), compareRuns)
simDiff <- findDiff(condFiles[4,], cleanLabel(rwyear), compareRuns)

figList <- updateCntList(figList,"bioDiff")
```

####Table `r figList$bioDiff`. All the differences between the biological Assumptions between the different runs
```{r,results = 'asis'}
kable(as.data.frame(bioDiff),align='c')
figList <- updateCntList(figList,"simDiff")
```

####Table `r figList$simDiff`. All the differences between the parameters for the HYSPLIT execution between the different runs
```{r,results = 'asis'}
kable(as.data.frame(simDiff),align='c')
figList <- updateCntList(figList,"jpgTable")
times <- c('051','053','063','073','091')
dates <- strftime(strptime(paste0(times,'0'),'%m%d'),'%b\n%d')
numTimes <- length(times)
contHeight <- numTimes * (6*1252/1920)/length(rwyear)
```

Here is the contour plots of the different runs at different times of the year:

####Table `r figList$jpgTable`. Contour plots of instaneous snapshots of the Moth population in the different runs at specific times throughout the migration time for FAW throughout late spring to fall.
```{r contours, fig.height=contHeight, fig.width=(6), message=FALSE, fig.show='hold'}

#fill the table with markdown paths to jpegs
conPaths <- paste(fullDir,'jpeg','Contours',sep='/')
contours <- vapply(conPaths,function(pth){
	vapply(times,function(tim){
		potJpegs <- list.files(pth,
			pattern=paste0('Moth_',tim),
			full.names = TRUE)
		return(potJpegs[!grepl('gsr2',potJpegs)][1])
		},'hi')
	},rep('hi',numTimes))

mosaicImage(contours,labelx=rwyear,labely=dates,offsetx=.08,marb=.2,marl=.15)
```

There are 5 main areas of mixing that are of interest to this project; Southern Missippi and Alabama along the gulf (Southern MSAL), Northern Missippi and Alabama near the tail end of the applachian mountains (Northern MSAL), Eastern PA near the eastern seaboard (Eastern PA), Central Pennsylvania in the plains region (Central PA), and Western Pennsylvania near Lake Erie (Western PA). One of the analysis that will be used in this project is the first occurance of a population in that area (firstOcc). For this use the defined area is the area of interest where most other times it will be done per grid cell. The other tool will be the mixing ratio of the two populations in the area of interest. This is defined as follows:

$$Mix_{ratio} =\frac{\log_{10} (FLMoth + 1) - \log_{10} (TXMoth + 1)}{\log_{10} (FLMoth + 1) + \log_{10} (TXMoth + 1)}$$

This is done to normalize the output on a range of -1 (All TX moths) to 1 (all FL moths). Also this puts it on a similar scale as the Haplotype ratio h2/h4 which goes from 0 (All TX) to > 2 (mostly FL) with the mixing region between 0.5 to 1.5. For this example the Moth populations in question will be all moths in the region summed over the entire year. The basic use is to do the calculation for every grid cell for every week of the year. Below is the summary for each of the regions and these values.

```{r simStats, warning = FALSE}
baseArea <- "C:/Users/Siddarta.Jairam/Documents/Documentation/"
areas <- c("Southern MSAL.kml", "Northern MSAL.kml", "Western PA.kml", "Central PA.kml", "Eastern PA.kml")

regStats <- vapply(fullDir,function(f){
	vapply(areas, function(area){
		return(c(simAreaStats(f, paste0(baseArea, area)),recursive=TRUE))
	}, rep(1,3))
	
}, matrix(0, nrow = 3, ncol = length(areas)))

mixTable <- cleanAllLabels(t(regStats[3,,]))
arrFLTable <- cleanAllLabels(t(regStats[1,,]))
arrTXTable <- cleanAllLabels(t(regStats[2,,]))

arrFinal <- matrix(paste(arrFLTable, arrTXTable, sep=', '),
	nrow=nrow(arrFLTable),
	dimnames=dimnames(arrFLTable))

figList <- updateCntList(figList,"mixTable")
figList <- updateCntList(figList,"arrTable")
```

####Table `r figList$mixTable`. The mixing ratio of the simulation in specific regions. The spatial range is the region and the temporal range is a summation of the whole year. The result is the average of this range.
`r kable(mixTable)`

####Table `r figList$arrTable`. The simulation first arrival for both populations in the specific regions. The first arrival is reported as a pair of the different populations (FL first occurance, TX first occurance) in weeks in the year.
`r kable(arrFinal)`


#Validation

For this project we have two main validation sets:

1. PestWatch data on trap captures across the U.S.
2. Haplotype analysis on a smaller subset of 1.

From this data we can compare the same output variables as that was looked at in the simulation output. The week of first occurance will be the same in the validation set. The difference is in the temporal resolution. The simulation has daily values which can easily be converted into their weekly forms. The trap captures are not so regular and often have odd temporal resolution. Farms with less than 10 captures for the entire year were thought to be untracable amount on the fringes of the moth population's extent. There is also a distinction with what first occurance means in this case. Should first date that the moths were found be the first occurance date (real method) or should it be the earilest that moths could have entered the traps and recorded the same record into the system (pred method)? The real method is more conservative as it will always at least have moths at that point, but the moths probably came earlier. The pred method shows when the lower bound to the value but could very well be a week where nothing was in the traps. The solution was to allow both methods to be caluculated but report the real method.

```{r qual}
qualTable <- rbind(
	c("-1 - -0.5", "0 - 0.5", "Mostly Texas"),
	c("0.5 - 0","0.5 - 1", "Mixed - Majority Texas"),
	c("0 - 0.5","1 - 1.5", "Mixed - Majority Florida"),
	c("0.5 - 1", "1.5 - inf", "Mostly Florida")
)
colnames(qualTable) <- c("Sim Mixing ratio", "h2/h4 ratio", "Qualitative meaning")
figList <- updateCntList(figList,"qualTable")
```

The genetic information is on a much smaller scale than the entire pestwatch system. Moths have to be pooled, transported and analyzed which takes time, effort and a sufficient number of moths (>15 moths). An effort was made in having samples spread out over the U.S. but southern US does not have many samples while the north-east has a rich genetic map. The genetic marker used to distinguish the Texas and Florida populations is the ratio of the h2 and h4 haplotypes. This range of possible numbers are all non-negative real numbers. To compare this to the simulation, the mixing ratio was introduced previously. These values are compared in `r figList$qualTable` along with their qualitative meaning of each range.

####Table `r figList$qualTable`. The qualitative meaning of the genetic information.
`r kable(qualTable)`


```{r valStats, warning = FALSE}

valStats <- vapply(params$years, function(yr){
	trapRec <- scrubTrap(params$trapDump, yr)
	csvVal <- summarizeValid(trapRec, yr, hapIn = sprintf(params$scrubbedHap, yr))
	vapply(areas, function(area){
		c(valAreaStats(csvVal, paste0(baseArea, area), params$niceGrid), recursive = TRUE)
	}, rep(1, 2))
	
}, matrix(0, nrow = 2, ncol = length(areas)))

dimnames(valStats)[[3]] <- params$years
valArrTable <- cleanAllLabels(t(valStats[1,,]))
valMixTable <- cleanAllLabels(t(valStats[2,,]))

figList <- updateCntList(figList,"valFirstOcc")
figList <- updateCntList(figList,"valMix")
```

The validation results for the defined areas of interest is shown below.

####Table `r figList$valMix`. The mixing ratio of the simulation in specific regions. The spatial range is the region and the temporal range is a summation of the whole year. The result is the average of this range.
`r kable(valMixTable)`

####Table `r figList$valFirstOcc`. The PestWatch data for first arrival for both populations in the specific regions. The first arrival is reported as weeks in the year.
`r kable(valArrTable)`

To show the differences between the mix ratio, the full map extent is shown below. Here the values of the contour is the simulation data and points are genetic data. The shade of gray represents the the mixing amount from white (pure TX population) to black (pure FL population).

```{r mapPaths, include = FALSE}

mixMapPaths <- vapply(fullDir, function(f){
	pathMap <- paste(f, "SimMixRatio.nc",sep='/')
	ncdf2trapgrid(f, pathOut = pathMap, shDoMix = TRUE)
	pathHap <- sprintf(params$scrubbedHap, file2year(f))
	runScripter("ncdf2contour.BAS", c(pathMap, 5, "bw", pathHap))
	paste(f, "jpeg", "Contours", "SimMixRatio.jpg", sep = '/')
}, "e")

occMapPaths <- vapply(fullDir, function(f){
	pathMap <- paste(f, "SimFirstOcc.nc",sep='/')
	ncdf2trapgrid(f, pathOut = pathMap)
# 	pathHap <- sprintf(scrubbedHap, file2year(f))
# 	runScripter("ncdf2contour.BAS", c(pathMap, 5, "bw", pathHap))
	paste(f, "jpeg", "Contours", "SimFirstOcc.jpg", sep = '/')
},'e')

figList <- updateCntList(figList,"mapMix")
figList <- updateCntList(figList,"mapFirstOcc")
compWidth <- (7*1920/1252)/length(rwyear) + .75 * 3
```

####Table `r figList$mapMix`. The spatial distribution of the simulation and validation results for the relative amounts of FL and TX strains. The contours represent the simulation output and the points represent the haplotype data. On both data sets, black represents a pure TX strain and white represent a pure FL strain.

```{r finMix, fig.height=7, fig.width=compWidth, message=FALSE, fig.show='hold'}
mosaicImage(mixMapPaths,labelx=rep("SimMixRatio",4), labely=rwyear,
 						offsetx=0, marb=.05, marl=.75, leftAlignYaxis = TRUE)
```

####Table `r figList$mapFirstOcc`. The spatial distribution of the simulation and validation results for the first arrival of moths. The contours represent the simulation output and the points represent the PestWatch data. On both data sets, black represents an arrival after September and white represents an arrival before May. 

```{r finOcc, fig.height=compHeight, fig.width=2, message=FALSE, fig.show='hold'}
# mosaicImage(occMapPaths,labelx=rep("SimFirstOcc",4), labely=rwyear,
#  						offsetx=0, marb=.05, marl=.35, leftAlignYaxis = TRUE)
```



```{r fig.height=(32/4), fig.width=((2*1920/1252)) , message=FALSE, fig.show='hold'}
# runScripter <- makeRunFun(goldLoc, "BAS")
# valid <- vapply(rwyear, function(des){
# 		direc <- paste(params$dirSim, des, sep='/')
# 		runScripter("ncdf2contour.BAS", direc, verbose = 0)
# 		return(paste(direc, "jpeg", "Contours", "Sim-TrapFirstOcc.jpg", sep='/'))
# 	},'e')
# 
# mosaicImage(valid,labelx=rep("Strict",4), labely=rwyear,
# 						offsetx=0, marb=.05, marl=.35, leftAlignYaxis = TRUE)
```
