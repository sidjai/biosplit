---
title: "Auto Report"
author: "Siddarta Jairam"
date: '`r strftime(Sys.time(),"%A, %B %d, %Y")`'
geometry: margin=1in
output: 
  word_document:
    reference_docx: rmdTemp.docx
params:
  runs: c("runFDHighLatThres", "runMultYearDv020")
  years: c(2013, 2011)
  dirSim: "C:/Users/Siddarta.Jairam/Documents/Hysplit Out Moth table"
  trapDump: "C:/Users/Siddarta.Jairam/Documents/Documentation/PestWatchDump.xlsx"
  scrubbedHap: "C:/Users/Siddarta.Jairam/Documents/Documentation/hapDat%d.csv"
  niceGrid: "None"
---

```{r setup, include=FALSE}
library(knitr)
library(jpeg)
library(biosplit)
knitr::opts_chunk$set(fig.width=7, fig.height=3, fig.pos='center', echo=FALSE, comment='>', dpi=800)
realWd <- system.file(package = "biosplit", "docs")
figList <- list()
source(paste(realWd,"rmdUtils.R",sep='/'))

```

This report will compare these runs:

```{r context}
#runs <- c('runDataRedo','runHelloWorld','runInterYear','runFLwinter')
#years <- c('2011','2012','2013','2014')
goldLoc <- "C:/Program Files/Golden Software/Surfer 12"
# params <- list()
#params$runs <- c('runInterYear','runAbsFlightLimit','runNightDurDel','runFlightAndNight')
# params$runs <- c("runBaseFullNight", "runBFNTOcueTemp", "runBFNTOcuePrec")
# params$runs <- c("runBaseNightandFlight", "runFDHighLatThres","runFNHighLatThres")
# params$years <- c("2013", "2013", "2013")
rwyear <- paste(params$years, params$runs, sep='/')
# params$dirSim <- "C:/Users/Siddarta.Jairam/Documents/Hysplit Out Moth table"
fullDir <- paste(params$dirSim, rwyear,sep='/')
numRuns <- length(rwyear)
compareRuns <- 1:numRuns
cat(paste(rwyear,colllapse='|'))
```

The conditions that the run was done in are as follows:

```{r conditions}
condFiles <- vapply(fullDir,function(x){
	readLines(paste(x,'Conditions.txt',sep='/'))
	},rep('one',5))
cat(condFiles[3:4,2])
```

The differences between the different runs are as follows:

```{r}
bioDiff <- findDiff(condFiles[3,], cleanLabel(rwyear), compareRuns)
simDiff <- findDiff(condFiles[4,], cleanLabel(rwyear), compareRuns)

figList <- updateCntList(figList,"bioDiff")
```

####Table `r figList$bioDiff`. All the differences between the biological Assumptions between the different runs
```{r,results = 'asis'}
kable(as.data.frame(bioDiff),align='c')
figList <- updateCntList(figList,"simDiff")
```

####Table `r figList$simDiff`. All the differences between the parameters for the HYSPLIT execution between the different runs
```{r,results = 'asis'}
kable(as.data.frame(simDiff),align='c')
figList <- updateCntList(figList,"jpgTable")
```

Here is the contour plots of the different runs at different times of the year:

####Table `r figList$jpgTable`. Contour plots of instaneous snapshots of the Moth population in the different runs at specific times throughout the migration time for FAW throughout late spring to fall.
```{r contours, fig.height=(20/length(rwyear)), fig.width=(6.5), message=FALSE, fig.show='hold'}
#define jpeg table
times <- c('051','053','063','073','091')
dates <- strftime(strptime(paste0(times,'0'),'%m%d'),'%b\n%d')
numTimes <- length(times)

#fill the table with markdown paths to jpegs
conPaths <- paste(fullDir,'jpeg','Contours',sep='/')
contours <- vapply(conPaths,function(pth){
	vapply(times,function(tim){
		potJpegs <- list.files(pth,
			pattern=paste0('Moth_',tim),
			full.names = TRUE)
		return(potJpegs[!grepl('gsr2',potJpegs)][1])
		},'hi')
	},rep('hi',numTimes))

mosaicImage(contours,labelx=rwyear,labely=dates,offsetx=.08,marb=.2,marl=.11)
```

There are 5 main areas of mixing that are of interest to this project; Southern Missippi and Alabama along the gulf (Southern MSAL), Northern Missippi and Alabama near the tail end of the applachian mountains (Northern MSAL), Eastern PA near the eastern seaboard (Eastern PA), Central Pennsylvania in the plains region (Central PA), and Western Pennsylvania near Lake Erie (Western PA). One of the analysis that will be used in this project is the first occurance of a population in that area (firstOcc). For this use the defined area is the area of interest where most other times it will be done per grid cell. The other tool will be the mixing ratio of the two populations in the area of interest. This is defined as follows:

$$Mix_{ratio} =\frac{\log_{10} (FLMoth + 1) - \log_{10} (TXMoth + 1)}{\log_{10} (FLMoth + 1) + \log_{10} (TXMoth + 1)}$$

This is done to normalize the output on a range of -1 (All TX moths) to 1 (all FL moths). Also this puts it on a similar scale as the Haplotype ratio h2/h4 which goes from 0 (All TX) to > 2 (mostly FL) with the mixing region between 0.5 to 1.5. For this example the Moth populations in question will be all moths in the region summed over the entire year. The basic use is to do the calculation for every grid cell for every week of the year. Below is the summary for each of the regions and these values.

```{r simStats}
baseArea <- "C:/Users/Siddarta.Jairam/Documents/Documentation/"
areas <- c("Southern MSAL.kml", "Northern MSAL.kml", "Western PA.kml", "Central PA.kml", "Eastern PA.kml")

regStats <- vapply(fullDir,function(f){
	vapply(areas, function(area){
		return(c(simAreaStats(f, paste0(baseArea, area)),recursive=TRUE))
	}, rep(1,3))
	
}, matrix(0, nrow = 3, ncol = length(areas)))

mixTable <- cleanAllLabels(t(regStats[3,,]))
arrFLTable <- cleanAllLabels(t(regStats[1,,]))
arrTXTable <- cleanAllLabels(t(regStats[2,,]))

arrFinal <- matrix(paste(arrFLTable, arrTXTable, sep=', '),
	nrow=nrow(arrFLTable),
	dimnames=dimnames(arrFLTable))

figList <- updateCntList(figList,"mixTable")
figList <- updateCntList(figList,"arrTable")
```

####Table `r figList$mixTable`. The mixing ratio of the simulation in specific regions. The spatial range is the region and the temporal range is a summation of the whole year. The result is the average of this range.
`r kable(mixTable)`

####Table `r figList$arrTable`. The simulation first arrival for both populations in the specific regions. The first arrival is reported as a pair of the different populations (FL first occurance, TX first occurance) in weeks in the year.
`r kable(arrFinal)`


#Validation


A simple measure that can be used to assess the accuracy of the model is to compare it to observed trap captures. These values were collected via PestWatch for 66 locations East of the Rockies. These were then turned into a regular grid of first occurrence values using krieging spatial averaging. This was compared with the first occurrences of the simulation and shown in the table below. 

```{r valStats}

valStats <- vapply(params$years, function(yr){
	trapRec <- scrubTrap(params$trapDump, yr)
	csvVal <- summarizeValid(trapRec, yr, hapIn = sprintf(params$scrubbedHap, yr))
	vapply(areas, function(area){
		c(valAreaStats(csvVal, paste0(baseArea, area), params$niceGrid), recursive = TRUE)
	}, rep(1, 2))
	
}, matrix(0, nrow = 2, ncol = length(areas)))

dimnames(valStats)[[3]] <- params$years
valArrTable <- cleanAllLabels(t(valStats[1,,]))
valMixTable <- cleanAllLabels(t(valStats[2,,]))

figList <- updateCntList(figList,"valFirstOcc")
figList <- updateCntList(figList,"valMix")
```

####Table `r figList$valMix`. The mixing ratio of the simulation in specific regions. The spatial range is the region and the temporal range is a summation of the whole year. The result is the average of this range.
`r kable(valMixTable)`

####Table `r figList$valFirstOcc`. The PestWatch data for first arrival for both populations in the specific regions. The first arrival is reported as weeks in the year.
`r kable(valArrTable)`


```{r, results = 'asis'}
pathTrapXlsx <- "C:/Users/Siddarta.Jairam/Documents/Documentation/PestWatchDump.xlsx"
trapGridFold <- "C:/Users/Siddarta.Jairam/Documents/Documentation/Result Files/"
trapGrid <- "2013firstOccTrap.grd"
trapGridTypes <- c(trapGrid, 
									 gsub("Trap", "TrapSoft", trapGrid),
									 gsub("Trap", "TrapStrict", trapGrid))
# valTab <- vapply(rwyear, function(x){
# 	direc <- paste(params$dirSim, x, sep='/')
# 	
# 	vapply(trapGridTypes, function(trapPath){
# 		predObv <- ncdf2trapgrid(direc,
# 														 paste0(trapGridFold,trapPath),
# 														 paste(direc, "Sim-TrapFirstOcc.nc",sep='/')
# 		)
# 		#The spatial average distance between the weeks
# 		mean(abs(predObv[,]),na.rm=TRUE)
# 	},1)
# 	
# },rep(1,3))
# 
# valTab <- cleanAllLabels(valTab)
# kable(valTab)
```

The strict blanking is taking out all the traps that had moths in their traps on the first week which does not prove that it is the first week of occurrence. The soft blanking is blanking the values that are outliers. Right now the clear outliers are at the beginning of the simulation in North Florida and central TX. This could be because of the overwintering population definition may be different than reality due to effects of other crops or warmer areas near the coast. Another reason could be because of having year round crops in certain areas that is not accounted for. There could also be a safe haven region in central TX and Florida where moths could survive and live through the winter without overwintering.

In any case, the "no blanking" case has 54 values, the soft blanking case has 50 values and the strict blanking has 33 values. These by location first ocurance values are then grided the same way to produce a comparison on the same spatial extent. However, the significance of the numbers should be changed with these number of values. The final graphs are shown below. The plotted variable is the simulation value subtracted from the gridded trap value. This means negative numbers (red) are areas where the simulation moths arrived earlier than in reality, and positive numbers (blue) are areas where the simulation moths arrived later than in reality.

```{r}
figList <- updateCntList(figList,"firstOccMap")
```

####Table `r figList$firstOccMap`. The spatial distribution of the differences between the predicted simulation values and the gridded trap capture values. Negative (red) represents and early simulation while positive (blue) values represent a late simulation

```{r fig.height=(32/4), fig.width=(6.5) , message=FALSE, fig.show='hold'}
# runScripter <- makeRunFun(goldLoc, "BAS")
# valid <- vapply(rwyear, function(des){
# 		direc <- paste(params$dirSim, des, sep='/')
# 		runScripter("ncdf2contour.BAS", direc, verbose = 0)
# 		return(paste(direc, "jpeg", "Contours", "Sim-TrapFirstOcc.jpg", sep='/'))
# 	},'e')
# 
# mosaicImage(valid,labelx=rep("Strict",4), labely=rwyear,
# 						offsetx=0, marb=.05, marl=.35, leftAlignYaxis = TRUE)
```
