---
title: "Auto Report"
author: "Siddarta Jairam"
date: '`r strftime(Sys.time(),"%A, %B %d, %Y")`'
output: 
  word_document:
    reference_docx: AutoReporttemp.docx
params:
	runs: c('runInterYear','runAbsFlightLimit','runNightDurDel')
	years: c(2013, 2013, 2013)
	dirSim: 'C:/Users/Siddarta.Jairam/Documents/Hysplit Out Moth table'
---

```{r setup, include=FALSE}
library(knitr)
library(jpeg)
library(biosplit)
knitr::opts_chunk$set(fig.width=6.5, fig.height=3,fig.pos='center',echo=FALSE,comment='>',dpi=800)
realWd <- 'C:/Users/Siddarta.Jairam/Documents/MothMigrationModel'
load(paste(realWd,"cfg.Rout",sep="/"))
figList <- list()
source(paste(realWd,"docs/rmdFunctions.R",sep='/'))
findDiff <- function(vecvars,compareInd=1:length(vecvars)){
	first <- compareInd[1]
	cond <- strsplit(vecvars,';')
	diff <- matrix('Same values', nrow = 1, ncol = length(vecvars))
	colnames(diff) <- rwyear
	locCnt <- 1 
	for (var in seq(1,length(cond[[1]]))){
		allCond <- vapply(1:length(vecvars),function(x){
			if(is.element(x,compareInd)){
				cond[[x]][var]
			} else "blank"},'one')
		test <- allCond[compareInd] %in% cond[[first]][var]
		
			
		if(!min(test)){
			#There is a difference between the runs so output it
			if(grepl("=",allCond[[first]])){
				parse <- strsplit(allCond,' = ')
				diff <- rbind(diff,vapply(1:length(vecvars),function(x){
					if(is.element(x,compareInd)){
						parse[[x]][2]
					} else "blank"},'one'))
				nrname <- parse[[first]][1]
			} else {
				diff <- rbind(diff,allCond)
				nrname <- paste0("Starting Location",locCnt)
				locCnt <- locCnt+1
			}
			
			#add the rowname from the thing that is different
			
			rownames(diff)[dim(diff)[1]] <- nrname
			
			#diff <- paste0(diff,paste(allCond,collapse=' != '),'\n')
		}
	}
	
	if (dim(diff)[1]>1){ 
		diff <- diff[-1,,drop=FALSE]
	}
	return(diff)
}
```

This report will compare these runs:

```{r context}
#runs <- c('runDataRedo','runHelloWorld','runInterYear','runFLwinter')
#years <- c('2011','2012','2013','2014')
runs <- c('runInterYear','runAbsFlightLimit','runNightDurDel','runFlightAndNight')
years <- c('2013','2013','2013','2013')
rwyear <- paste(params$years, params$runs, sep='/')
fullDir <- paste(params$dirSim,rwyear,sep='/')
numRuns <- length(rwyear)
compareRuns <- 1:numRuns
cat(paste(rwyear,colllapse='|'))
```

The conditions that the run was done in is as follows:

```{r conditions}
condFiles <- vapply(fullDir,function(x){
	readLines(paste(x,'Conditions.txt',sep='/'))
	},rep('one',5))
cat(condFiles[3:4,2])
```

The differences between the different runs are as follows:

```{r}
bioDiff <- findDiff(condFiles[3,],compareRuns)
simDiff <- findDiff(condFiles[4,],compareRuns)

figList <- updateCntList(figList,"bioDiff")
```

####Table `r figList$bioDiff`. All the differences between the biological Assumptions between the different runs
```{r,results = 'asis'}
kable(as.data.frame(bioDiff),align='c')
figList <- updateCntList(figList,"simDiff")
```

####Table `r figList$simDiff`. All the differences between the parameters for the HYSPLIT execution between the different runs
```{r,results = 'asis'}
kable(as.data.frame(simDiff),align='c')
figList <- updateCntList(figList,"jpgTable")
```

Here is the output:

####Table `r figList$jpgTable`. Contour plots of instaneous snapshots of the Moth population in the different runs at specific times throughout the migration time for FAW throughout late spring to fall.
```{r fig.height=(20/length(rwyear)),fig.show='hold'}
#define jpeg table
times <- c('051','053','063','073','091')
dates <- strftime(strptime(paste0(times,'0'),'%m%d'),'%b\n%d')
numTimes <- length(times)

#fill the table with markdown paths to jpegs
conPaths <- paste(fullDir,'jpeg','Contours',sep='/')
contours <- vapply(conPaths,function(pth){
	vapply(times,function(tim){
		potJpegs <- list.files(pth,
			pattern=paste0('Moth_',tim),
			full.names = TRUE)
		return(potJpegs[!grepl('gsr2',potJpegs)][1])
		},'hi')
	},rep('hi',numTimes))

mosaicImage(contours,labelx=rwyear,labely=dates,offsetx=.08,marb=.2,marl=.11)
```

#Validation

A simple measure that can be used to assess the accuracy of the model is to compare it to observed trap captures. This values were collected via PestWatch for 66 locations East of the Rockies. These were then turned into a regular grid of first occurance values using krieging spatial averaging. This was compared with the first occurances of the simulation and shown in the table below. 

```{r}
figList <- updateCntList(figList,"firstOccTable")
```

####Table `r figList$firstOccTable`. The average of the absolute value of the difference between the simulation first Occurance and the trap first occurance

```{r}
trapGridFold <- "C:/Users/Siddarta.Jairam/Documents/Documentation/Result Files/"
trapGrid <- "firstOccTrap.grd"
trapGridTypes <- c(trapGrid, 
									 gsub("Trap", "TrapSoft", trapGrid),
									 gsub("Trap", "TrapStrict", trapGrid))
valTab <- vapply(rwyear, function(x){
	direc <- paste(cfg$SimOutFold, x, sep='/')
	
	vapply(trapGridTypes, function(trapPath){
		predObv <- ncdf2trapgrid(direc,
														 paste0(trapGridFold,trapPath),
														 paste(direc, "Sim-TrapFirstOcc.nc",sep='/')
		)
		#The spatial average distance between the weeks
		mean(abs(predObv),na.rm=TRUE)
	},1)
	
},rep(1,3))

kable(as.data.frame(valTab))
```

The strict blanking is taking out all the traps that had moths in their traps on the first week which does not prove that it is the first week of occurance. The soft blanking is blanking the values that are outliers. Right now the clear outliers are at the begining of the simulation in North florida and central TX. This could be because of the overwintering population definition may be different than reality due to effects of other crops or warmer areas near the coast. Another reason could be because of having year round crops in certain areas that is not accounted for. There could also be a safe haven region in central TX and Florida where moths could survive and live through the winter without overwintering.

In any case, the "no blanking" case has 54 values, the soft blanking case has 50 values and the strict blanking has 33 values. These by area values are then grided the sam way to produce a comparision on the same spatial extent. However, the significance of the numbers should be changed with these number of values.
